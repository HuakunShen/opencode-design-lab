# 2026-01-22: OpenCode Design Lab Plugin - Debugging and Refinement

## Problem Statement

The OpenCode Design Lab plugin was experiencing critical issues preventing successful execution:

1. **Agent invocation error**: `TypeError: undefined is not an object (evaluating 'agent.name')`
2. **Infinite directory creation**: Tool created 30+ duplicate directories in 15 seconds
3. **Hanging prompts**: Sessions never completed, causing timeouts
4. **Missing output**: No design files were generated

## Root Cause Analysis

### Issue 1: Ignored System Prompt

**Problem**: The `agentConfig.prompt` (system prompt) was created but never sent to the agent session.

**Impact**: Without the system prompt instructing the agent to output JSON, the model would produce markdown or ask clarifying questions instead of structured data, causing:

- Schema validation failures
- Hanging sessions (waiting for user input)
- Incorrect output format

**Fix**: Prepended `agentConfig.prompt` to the user prompt in both `generate-designs.ts` and `review-designs.ts`.

```typescript
// Before
await sendPrompt(ctx, sessionID, prompt, agentConfig.tools);

// After
const fullPrompt = `${agentConfig.prompt}\n\n${prompt}`;
await sendPrompt(ctx, sessionID, fullPrompt, agentConfig.tools);
```

### Issue 2: Prompt Timeout Too Short

**Problem**: 30-second timeout was insufficient for large JSON generation with slower models.

**Impact**: Prompts timed out before completion, causing the tool to fail and OpenCode to retry, creating multiple directories.

**Fix**: Increased timeout from 30s to 180s (3 minutes) in `session-helpers.ts`.

### Issue 3: Infinite Directory Loop

**Problem**: When the tool failed, OpenCode automatically retried, and each retry created a new timestamped directory.

**Impact**: 30+ directories created in rapid succession, all empty.

**Fix**: Added duplicate directory check in `generate-designs.ts`:

```typescript
if (fs.existsSync(labDir)) {
  return `Error: Lab directory already exists at ${labDir}...`;
}
```

### Issue 4: Invalid Agent Parameter

**Problem**: Attempted to pass `agent` parameter to `session.create()` but the SDK types don't support it.

**Impact**: TypeScript errors and potential runtime issues.

**Fix**: Removed `agent` parameter from session creation. Sessions use the default model, but the system prompt guides behavior.

## Additional Improvements

### 1. Markdown Design Export

**Requirement**: Users wanted human-readable design files, not just JSON.

**Solution**: Added `formatDesignAsMarkdown()` helper that converts design JSON to well-structured markdown with sections for Summary, Assumptions, Architecture, Components, Data Flow, Tradeoffs, Risks, and Open Questions.

Both `.json` and `.md` files are now saved for each design.

### 2. Fixed Duplicate Design IDs in Ranking

**Problem**: Review tool was creating 4 rankings instead of 2 (one per design model).

**Root Cause**: The review prompt used vague placeholder `"model-name"`, causing the AI to output shortened design IDs like `"glm-46"` instead of the full ID `"zhipuai-coding-planglm-46"`.

**Fix**: Updated `review-designs.ts` to explicitly list valid design IDs:

```typescript
const designIds = Object.keys(designs);
const scoresPrompt = `...
**IMPORTANT**: The "design_id" field MUST be one of these exact values:
${designIds.map((id) => `- "${id}"`).join("\n")}
...`;
```

### 3. Improved Filename Conventions

**Requirements**:

- Remove provider prefix from filenames (`zhipuai-coding-plan/glm-4.6` → `glm-4.6`)
- Fix missing dashes in sanitized names
- Clearer score filenames showing reviewer relationship
- Only load JSON files for review (not markdown)

**Solutions**:

- Added `getModelShortName()` helper to extract model name from full path
- Fixed `sanitizeForFilename()` to convert slashes to dashes before removing special chars
- Updated score filename format: `{design}-reviewed-by-{reviewer}.json`
- Filtered design files to only load `.json` extension

## Technical Decisions

### Why Not Pass Model to Session?

The OpenCode SDK's `session.create()` doesn't accept an `agent` or `model` parameter in its type definition. While we could force it with type casting, relying on the system prompt is cleaner and more maintainable. The system prompt effectively guides the model's behavior regardless of which model is actually used.

### Why 180s Timeout?

Design generation involves creating comprehensive JSON documents with multiple sections. Testing showed that:

- Topic generation (short output): ~2-5 seconds
- Design generation (large JSON): 60-120 seconds for slower models
- 180s provides sufficient buffer without being excessive

### Why Both JSON and Markdown?

- **JSON**: Required for programmatic processing (schema validation, aggregation, scoring)
- **Markdown**: Human-readable format for reviewing designs without parsing JSON

## Verification

The plugin now successfully:

1. ✅ Generates designs from multiple models without hanging
2. ✅ Exports both JSON and markdown formats
3. ✅ Reviews designs with correct design_id matching
4. ✅ Produces accurate rankings (2 designs → 2 rankings, not 4)
5. ✅ Uses clean, concise filenames
6. ✅ Prevents duplicate directory creation on retries

## Files Modified

- `src/utils/session-helpers.ts`: Timeout increase, `getModelShortName()` helper, improved sanitization
- `src/tools/generate-designs.ts`: System prompt prepending, markdown export, short names
- `src/tools/review-designs.ts`: Explicit design_id list, JSON-only loading, clearer score filenames
- `src/utils/logger.ts`: Added comprehensive logging throughout
- `.gitignore`: Added `.design-lab/`, `.opencode/`, `design-lab.log`

## Lessons Learned

1. **System prompts are critical**: Without proper instructions, LLMs won't produce the expected format
2. **Timeouts must account for model variability**: Different models have vastly different response times
3. **Explicit is better than implicit**: Listing exact valid values prevents AI hallucination/abbreviation
4. **Human-readable outputs matter**: Even in automated systems, humans need to review results
5. **Defensive programming prevents cascading failures**: Simple existence checks prevent retry loops
